<!DOCTYPE html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {border: 1px solid brown;}
        H1 {float: left;}
        .button{
            background-color:#55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }
        #receiptList {
            border: 1px solid green;
            clear: both;
        }
        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }
        a{
            margin: 5px;
            background-color:rosybrown;
            border: 1px solid #229;
            width: 50px;
            color: white;
            text-align: center;
        }
        .add-tag{
            background-color:#55A;
            border: 1px solid #229;
            width: 50px;
            color: powderblue;
            text-align: center;
        }

    </style>
    <script>
        //const api = "http://ec2-13-58-78-137.us-east-2.compute.amazonaws.com:8080";
        const api="";
        $(start())

        function start() {
            $.getJSON(api + "/receipts", function(receipts){
                $("#receiptList").empty();
                for(var i = 0; i <= receipts.length - 1; i++) {
                    var current = receipts[i];
                    $(`<div class="receipt">
                            <div class = "merchant">${current.merchantName}</div>
                            <div class = "amount">${current.value}</div>
                            <div class="tags" id = ${current.id}>
                                <button class = "add-tag" name = ${current.id}  onclick="addTag(this)">Add</button>
                            </div>
                        </div>`
                    ).appendTo($("#receiptList"));
                    current.tags.forEach(function(tag) {
                        var a = document.createElement('a');
                        a.text = tag
                        a.name = current.id
                        a.className = "tagValue"
                        document.getElementById(current.id).appendChild(a)
                    });
                }
            })
        }

        function isNumberKey(evt)
        {
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode != 46 && charCode > 31
                && (charCode < 48 || charCode > 57))
                return false;
            return true;
        }

        $(function(){
            $("#add-receipt").click(function() {
                $("#AddBox").css("visibility","visible");
            })
            $("#cancel-receipt").click(function(){
                $("#AddBox").css("visibility","hidden");
            });
            $('#save-receipt').on('click', function () {

                var merchant = $("#merchant").val();
                var amount = $("#amount").val();

                $.ajax({
                    method: "POST",
                    url: api + "/receipts",
                    data: JSON.stringify({"merchant": merchant, "amount": amount}),
                    contentType: "application/json"
                }).done(function (id) {
                    $("#AddBox").css("visibility","hidden");
                    $("#merchant").val("");
                    $("#amount").val("");

                    var temp = "<div class='receipt' id='" + id + "'>";
                    temp += "<div class='merchant'>" + merchant + "</div>";
                    temp += "<div class='amount'>" + amount + "</div>";
                    temp += "<span class='tags'><button class='add-tag' name='" + id + "' onclick='addTag(this)'>Add</button></span>";
                    temp += "</div>";

                    $("#receiptList").append(temp);

                })
            });

        });
        function addTag(input) {
            var text = document.createElement('input')
            text.type = "text"
            text.placeholder = "Add Tag"
            text.name = input.name
            text.className = "tag_input"
            text.addEventListener('keypress', function(event){
                if (event.keyCode == 13) {
                    $.ajax({
                        url: api+"/tags/"+text.value,
                        type: "PUT",
                        data: JSON.stringify(parseInt(this.name)),
                        contentType: "application/json; charset=utf-8",
                        dataType:    "json",
                        success: function(){
                            var button = document.createElement('a');
                            button.text = text.value
                            button.name = input.name
                            button.className = "tagValue"

                            document.getElementById(input.name).appendChild(button)
                            $("input").remove()

                        },
                    });
                }
            });
            document.getElementById(input.name).appendChild(text)
        }

        $(document).on('click','.tagValue',function(){
           //alert($(this).text());
           //alert($(this).attr('name'));
            $.ajax({
                type: 'PUT',
                url: '/tags/'+$(this).text(),
                data: $(this).attr('name'),
                contentType: "application/json",
                dataType: 'json',
            });
            $(this).remove();

        });

    </script>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <button id="add-receipt" class="button">+</button>
    <div id="AddBox" style="visibility: hidden">
        <input type="text" id="merchant" placeholder="Merchant">
        <input onkeypress="return isNumberKey(event)" type="text" id="amount" placeholder="Amount">
        <input type="button" id="cancel-receipt" value="Cancel">
        <input type="button" id="save-receipt" value="Save">
    </div>

    <div id = "addReceiptDialogue"></div>
    <div id="receiptList"></div>
</DIV>
</body>

